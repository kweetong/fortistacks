tosca_definitions_version: cloudify_dsl_1_3

description: >
  Mini poc deployment : 2 tenants networks 1 fortios in the middle with 1 rule for
  allowing traffic 2 ubuntu with apache to generate traffic. Everyone has floating ip.
  You MUST upload a license file with cfy secrets like:
  $ cfy secret create fgt_license -f ../../fortigate/FGT.lic

imports:
  - http://www.getcloudify.org/spec/cloudify/4.6/types.yaml
  - http://www.getcloudify.org/spec/openstack-plugin/2.9.0/plugin.yaml
  - plugins/cloudify-fortigate-plugin/plugin.yaml
inputs:
  fos_image:
    default: {}
  fos_flavor:
    default: {}
  key_name:
    default: {}


  mgmt_network_name:
    default: "mgmt"
  external_network_name:
    default: "ext_net"



dsl_definitions:

# The configuration of openstack access is in the file /etc/cloudify/openstack_config.json
# For simplicity of blueprint reading.

#  ##openstack_config: &openstack_config
#    username: { get_secret: keystone_username }
#    password: { get_secret: keystone_password }
#    tenant_name: { get_secret: keystone_tenant_name }
#    auth_url: { get_secret: keystone_url }
#    region: { get_secret: region }

node_templates:


  left_network:
    type: cloudify.openstack.nodes.Network
    properties:
      resource_id: left_network_openstack

  left_subnet:
    type: cloudify.openstack.nodes.Subnet
    properties:
      ##openstack_config: *openstack_config
      resource_id: left_subnet_openstack
      subnet:
        host_routes: [ {"nexthop": "10.40.40.254", "destination": "10.20.20.0/24"} ]
        allocation_pools:
          - start: 10.40.40.3
            end: 10.40.40.140
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            args:
              cidr: 10.40.40.0/24
              ip_version: 4
              gateway_ip: null
      cloudify.interfaces.validation:
        creation:
          inputs:
            args:
              cidr: 10.40.40.0/24
              ip_version: 4
              gateway_ip: null
    relationships:
      - target: left_network
        type: cloudify.relationships.contained_in



  fortigate:
    type: cloudify.openstack.nodes.Server
    properties:
      server:
        image_name: { get_input: fos_image }
        flavor_name: { get_input: fos_flavor }
        #useless key_name for fortinet but mandatory for openstack
        key_name: { get_input: key_name }
      agent_config:
        install_method: none # do not install agent
      ##openstack_config: *openstack_config
      management_network_name: { get_input: mgmt_network_name }
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          inputs:
            args:
              userdata: |
                config system admin
                    edit "admin"
                        set password fortinet
                    next
                end
                #FOS VM Config File
                config system interface
                edit port1
                 set mode dhcp
                 set allowaccess ping https ssh http snmp fgfm
                 set defaultgw enable
                next
                edit port2
                set mode dhcp
                set allowaccess ping
                 set defaultgw disable
                next
                edit port3
                set mode dhcp
                set allowaccess ping
                 set defaultgw disable
                next
                end
                config firewall policy
                edit 1
                set name "Allow any any"
                set srcintf "any"
                set dstintf "any"
                set srcaddr "all"
                set dstaddr "all"
                set action accept
                set schedule "always"
                set service "ALL"
                set nat enable
                next
                end

    relationships:
      - target: left_subnet
        type: cloudify.relationships.connected_to
#      - target: right_subnet
#        type: cloudify.relationships.depends_on
#      - target: my_security_group
#        type: cloudify.openstack.server_connected_to_security_group
#not compatible with portsecurity disabled

  fortigate-api:
    type: fortinet.nodes.Fortigate
    properties:
      username: "admin"
      password: "fortinet"
      vdom: "root"
      use_ssl: False
      verify_ssl: False
    relationships:
      - type: cloudify.relationships.contained_in
        target: fortigate
